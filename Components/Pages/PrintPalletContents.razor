@page "/print-pallet-contents/{PalletId}"
@layout PrintLayout
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject IWarehouseDataService DataService
@inject IBarcodeService BarcodeService

<PageTitle>Print Palle Indhold</PageTitle>

<div class="contents-page">
    <div class="contents-sheet">
        <div class="sheet-title">Palle Indhold</div>
        <div class="sheet-pallet">Palle: @PalletId</div>
        <div class="sheet-date">Udskrevet: @DateTime.Now.ToString("yyyy-MM-dd HH:mm")</div>

        @if (items.Count == 0)
        {
            <div class="empty-state">Ingen indholdslinjer fundet for pallen.</div>
        }
        else
        {
            @foreach (var item in items)
            {
                var productCode = item.ProductNumber;
                var productSvg = BarcodeService.GenerateCode128Svg(productCode, 700, 110);
                var expirySvg = IsScannableExpiry(item.ExpiryDate)
                    ? BarcodeService.GenerateCode128Svg(item.ExpiryDate, 420, 64)
                    : string.Empty;
                var expiryDisplay = FormatExpiryForDisplay(item.ExpiryDate);
                <div class="item-row">
                    <div class="item-header">
                        <strong>Vare:</strong> @item.ProductNumber
                        <span class="item-sep">|</span>
                        <strong>Holdbarhed:</strong> <span class="item-expiry">@expiryDisplay</span>
                        <span class="item-sep">|</span>
                        <strong>Antal:</strong> @item.Quantity
                    </div>
                    @if (!string.IsNullOrWhiteSpace(productSvg))
                    {
                        <div class="item-barcode">@((MarkupString)productSvg)</div>
                        <div class="item-code">@productCode</div>
                    }
                    @if (!string.IsNullOrWhiteSpace(expirySvg))
                    {
                        @* Explicit visual label to avoid confusion with product barcode. *@
                        <div class="item-expiry-label">Dato / Holdbarhed (ikke varenummer)</div>
                        <div class="item-expiry-barcode">@((MarkupString)expirySvg)</div>
                        <div class="item-expiry-code">@expiryDisplay</div>
                    }
                </div>
            }
        }
    </div>

    <div class="screen-only mt-3 d-flex gap-2 justify-content-center">
        <button class="btn btn-primary" @onclick="HandlePrintAsync">Print igen</button>
        <button class="btn btn-outline-secondary" @onclick="HandleBackAsync">Tilbage</button>
    </div>
</div>

@code {
    [Parameter]
    public string PalletId { get; set; } = string.Empty;

    private readonly List<PalletContentItemRecord> items = new();

    protected override async Task OnParametersSetAsync()
    {
        items.Clear();
        items.AddRange(await DataService.GetPalletContentsAsync(PalletId));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await HandlePrintAsync();
        }
    }

    private async Task HandlePrintAsync()
    {
        await JS.InvokeVoidAsync("lagerPrint.printAndClosePopupTab");
    }

    private async Task HandleBackAsync()
    {
        await JS.InvokeVoidAsync("lagerPrint.closePopupTabOrNavigateHome");
    }

    private static bool IsScannableExpiry(string expiryDate)
    {
        return !string.IsNullOrWhiteSpace(expiryDate)
            && expiryDate.Length == 8
            && expiryDate.All(char.IsDigit);
    }

    private static string FormatExpiryForDisplay(string expiryDate)
    {
        if (!IsScannableExpiry(expiryDate))
        {
            return expiryDate;
        }

        return $"{expiryDate[..4]}-{expiryDate[4..6]}-{expiryDate[6..8]}";
    }
}
