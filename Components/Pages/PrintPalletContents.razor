@page "/print-pallet-contents/{PalletId}"
@layout PrintLayout
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject IWarehouseDataService DataService
@inject BarcodeService BarcodeService

<PageTitle>Print Palle Indhold</PageTitle>

<div class="contents-page">
    <div class="contents-sheet">
        <div class="sheet-title">Palle Indhold</div>
        <div class="sheet-pallet">Palle: @PalletId</div>
        <div class="sheet-date">Udskrevet: @DateTime.Now.ToString("yyyy-MM-dd HH:mm")</div>

        @if (items.Count == 0)
        {
            <div class="empty-state">Ingen indholdslinjer fundet for pallen.</div>
        }
        else
        {
            @foreach (var item in items)
            {
                var productCode = item.ProductNumber;
                var svg = BarcodeService.GenerateCode128Svg(productCode, 700, 110);
                <div class="item-row">
                    <div class="item-header">
                        <strong>Vare:</strong> @item.ProductNumber
                        <span class="item-sep">|</span>
                        <strong>Holdbarhed:</strong> <span class="item-expiry">@item.ExpiryDate</span>
                        <span class="item-sep">|</span>
                        <strong>Antal:</strong> @item.Quantity
                    </div>
                    @if (!string.IsNullOrWhiteSpace(svg))
                    {
                        <div class="item-barcode">@((MarkupString)svg)</div>
                        <div class="item-code">@productCode</div>
                    }
                </div>
            }
        }
    </div>

    <div class="screen-only mt-3 d-flex gap-2 justify-content-center">
        <button class="btn btn-primary" @onclick="PrintNow">Print igen</button>
        <button class="btn btn-outline-secondary" @onclick="BackNow">Tilbage</button>
    </div>
</div>

@code {
    [Parameter]
    public string PalletId { get; set; } = string.Empty;

    private readonly List<PalletContentItemRecord> items = new();

    protected override async Task OnParametersSetAsync()
    {
        items.Clear();
        items.AddRange(await DataService.GetPalletContentsAsync(PalletId));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await PrintNow();
        }
    }

    private async Task PrintNow()
    {
        await JS.InvokeVoidAsync("lagerPrint.printAndClose");
    }

    private async Task BackNow()
    {
        await JS.InvokeVoidAsync("lagerPrint.closeTabOrGoHome");
    }
}
